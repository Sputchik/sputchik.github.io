<!DOCTYPE html><html lang="en"><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Twitch VOD Viewer</title><style>:root{--bg-color:#f8f8f8;--scrollbar-bg:#f0f0f0;--scrollbar-thumb:#c1c1c1;--scrollbar-thumb-hover:#a1a1a1;--text-color:#333;--panel-bg:#fff;--panel-border:#ddd;--chat-border:#eee;--timestamp-color:#999;--game-name-color:#555;--resize-handle:#ddd;--resize-handle-hover:#6441a5;--chat-header-bg:#f4f4f4;--viewer-icon-color:#971311;--accent-color:#6741a5;--sub-color:#8b04c1}[data-theme=dark]{--bg-color:#000000;--scrollbar-bg:#000000;--scrollbar-thumb:#222222;--scrollbar-thumb-hover:#6441a5;--text-color:#e5e5e5;--panel-bg:#0f0f0f;--panel-border:#333;--chat-border:#333;--timestamp-color:#888;--game-name-color:#aaa;--resize-handle:#333333;--resize-handle-hover:#6441a5;--chat-header-bg:#000000;--viewer-icon-color:#ff6b68}*{scrollbar-width:thin;scrollbar-color:var(--scrollbar-thumb) var(--scrollbar-bg)}a{color:inherit;text-decoration:none}a:focus,a:hover{text-decoration:underline}body{font-family:Arial,sans-serif;font-size:15px;margin:0;padding:0;background:var(--bg-color);color:var(--text-color);overflow-y:hidden}.container{display:flex;flex-direction:row;max-width:100%;height:100dvh}.left-panel{flex:1;min-width:0;padding-left:10px;padding-right:10px;display:flex;flex-direction:column;height:100%;overflow-y:auto}.video-container{position:relative;width:100%;padding-top:56.25%;background:#000}#video-player{position:absolute;top:0;left:0;width:100%;height:100%}.stream-info{margin-top:12px;padding:8px;padding-top:12px;background:var(--panel-bg);border-radius:4px;box-shadow:0 1px 3px rgba(0,0,0,.1)}.stream-info-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}.stream-title{font-size:1rem;margin:0}.game-name{color:var(--game-name-color);font-size:.8rem;margin-top:3px}.viewers-count{font-weight:700;margin-right:55px;display:flex;align-items:center}.chat-toggle{background:var(--panel-bg);color:var(--text-color);border:1px solid var(--panel-border);border-radius:4px;padding:8px 15px;cursor:pointer;font-weight:700}.description{font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;font-size:15px;margin-top:15px;padding:15px;background:var(--panel-bg);border-radius:4px;box-shadow:0 1px 3px rgba(0,0,0,.1);overflow-wrap:break-word}.chat-panel{resize:horizontal;min-width:200px;width:380px;background:var(--panel-bg);border-left:1px solid var(--panel-border);display:flex;flex-direction:column;padding-bottom:env(safe-area-inset-bottom);padding-top:env(safe-area-inset-top);position:relative}.chat-header{padding:5px 9px;border-bottom:1px solid var(--panel-border);font-weight:700;background:var(--chat-header-bg);display:flex;justify-content:space-between;align-items:center}.chat-header-btn{background:0 0;border:none;cursor:pointer;padding:4px;border-radius:4px;color:var(--text-color)}.chat-event-log{background:var(--panel-bg);border-bottom:1px solid var(--panel-border);max-height:200px;overflow-y:auto;padding:8px;display:none}.chat-event-log.has-events{display:block}.chat-event-item{padding:6px 8px;margin-bottom:4px;border-radius:4px;font-size:13px;line-height:1.3;border-left:3px solid}.chat-event-item.poll{background:rgba(145,70,255,.1);border-left-color:#9146ff}.chat-event-item.prediction{background:rgba(0,173,181,.1);border-left-color:#00adb5}.chat-event-item.raid{background:rgba(255,158,39,.1);border-left-color:#ff9e27}.chat-event-item.pin{background:rgba(100,65,165,.1);border-left-color:#6441a5}.chat-event-item.misc{background:rgba(139,4,193,.1);border-left-color:#8b04c1}.chat-event-title{font-weight:700;margin-bottom:2px}.chat-event-description{color:var(--timestamp-color);font-size:12px}.chat-event-status{float:right;font-size:11px;font-weight:700;text-transform:uppercase}.chat-event-status.active{color:#0f0}.chat-event-status.completed{color:#fa0}.chat-event-status.resolved{color:#00adb5}.chat-messages{overflow-y:scroll;padding:10px}.chat-message{padding:5px 0;border-bottom:1px solid var(--chat-border)}.chat-username{font-weight:700}.chat-text{word-break:break-word}.timestamp{color:var(--timestamp-color);font-size:.75rem;margin-right:5px}.monet,.poll,.prediction{background-color:var(--panel-bg);border-left:3px solid #6441a5;padding-left:5px}.inraid{background-color:#ffad000f;border-left:3px solid #ff9e27;padding-left:5px}.mod{background-color:#ff00000a;border-left:3px solid red;padding-left:5px;font-style:italic}@media (orientation:portrait){.container{position:relative;display:grid;grid-template-areas:"video" "info" "chat";grid-template-rows:auto auto 1fr;height:100dvh}.left-panel{display:contents;height:auto;padding:10px}.video-container{grid-area:video}.stream-info{grid-area:info;margin-bottom:0}#chat-panel{grid-area:chat;position:relative;width:100%;border-left:none;overflow-y:auto;padding-bottom:env(safe-area-inset-bottom)}.description{position:absolute;top:100dvh;left:0;right:0}#resize-handle{display:none}.viewers-count{margin-right:5px}}.resize-handle{width:5px;background-color:var(--resize-handle);cursor:col-resize;transition:background-color .2s}.resize-handle.active,.resize-handle:hover{background-color:var(--resize-handle-hover)}.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;justify-content:center;align-items:center}.settings-panel{background:var(--panel-bg);border:1px solid var(--panel-border);border-radius:4px;padding:20px;min-width:300px;width:40vw;max-width:80vw;max-height:80vh;height:75%;overflow-y:auto;color:var(--text-color);box-shadow:0 1px 3px rgba(0,0,0,.1)}.progress-bar{width:100%;background:var(--panel-border);border-radius:4px;margin-top:5px;padding:2px;font-size:12px;text-align:center;color:var(--bg-color);display:none}.popout{position:absolute;top:100px;left:100px;width:350px;height:400px;max-width:80vw;max-height:80vh;background-color:var(--bg-color);border:1px solid var(--panel-border);border-radius:4px;z-index:10;display:flex;flex-direction:column;resize:both;overflow:auto}</style><div class="container"><div class="left-panel"><div class="video-container"><video id="video-player" webkit-playsinline="true" playsinline="true" controls preload="auto">Your browser does not support the video tag.</video></div><div class="stream-info"><div class="stream-info-header"><div><h1 class="stream-title" id="stream-title">Loading...</h1><div style="display:flex;align-items:center;gap:6px;margin-top:6px"><svg fill="var(--game-name-color)" width="16" height="16" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg" id="memory-gamepad-center"><path d="M14 1V2H15V7H20V8H21V14H20V15H15V20H14V21H8V20H7V15H2V14H1V8H2V7H7V2H8V1H14M13 8H9V9H8V13H9V14H13V13H14V9H13V8Z"/></svg><span class="game-name" id="game-name">Loading...</span></div></div><div style="display:flex;align-items:center"><span class="viewers-count" style="gap:3px;display:flex;align-items:center;color:var(--viewer-icon-color)"><svg width="20" height="20" viewBox="0 0 20 20" aria-hidden="true"><path fill="currentColor" fill-rule="evenodd" d="M5 7a5 5 0 1 1 6.192 4.857A2 2 0 0 0 13 13h1a3 3 0 0 1 3 3v2h-2v-2a1 1 0 0 0-1-1h-1a3.99 3.99 0 0 1-3-1.354A3.99 3.99 0 0 1 7 15H6a1 1 0 0 0-1 1v2H3v-2a3 3 0 0 1 3-3h1a2 2 0 0 0 1.808-1.143A5.002 5.002 0 0 1 5 7zm5 3a3 3 0 1 1 0-6 3 3 0 0 1 0 6z" clip-rule="evenodd"></path></svg><span id="viewer-count">0</span></span><button class="theme-toggle" id="theme-toggle-btn" style="margin-left:8px;background:var(--panel-bg);color:var(--text-color);border:1px solid var(--panel-border);border-radius:4px;padding:8px 15px;cursor:pointer"><svg id="theme-icon" width="16" height="16" viewBox="0 0 24 24" style="vertical-align:text-bottom"><path id="moon-icon" fill="currentColor" d="M21.53 15.93c-.16-.27-.61-.69-1.73-.49a8.46 8.46 0 01-1.88.13 8.409 8.409 0 01-5.91-2.82 8.068 8.068 0 01-1.44-8.66c.44-1.01.13-1.54-.09-1.76s-.77-.55-1.83-.11a10.318 10.318 0 00-6.32 10.21 10.475 10.475 0 007.04 8.99 10 10 0 002.89.55c.16.01.32.02.48.02a10.5 10.5 0 008.47-4.27c.67-.93.49-1.519.32-1.79z" style="display:none"/><path id="sun-icon" fill="currentColor" d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0a.996.996 0 000-1.41l-1.06-1.06zm1.06-10.96a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/></svg></button></div></div></div><div class="description" id="description-container" style="display:none"><details><summary></summary><div id="description-content">Loading...</div></details></div></div><div class="resize-handle" id="resize-handle"></div><div class="chat-panel" id="chat-panel"><div class="chat-header"><span>Live Chat (WORK IN PROGRESS)</span><div style="display:flex;gap:5px"><button class="chat-header-btn" title="Open user ChatLog by username" id="chatlog-btn"><svg width="20" height="20" viewBox="0 0 24 24"><path fill="none" d="M18.5 19.5L20 21M11 14C7.13401 14 4 17.134 4 21H11M19 17.5C19 18.8807 17.8807 20 16.5 20C15.1193 20 14 18.8807 14 17.5C14 16.1193 15.1193 15 16.5 15C17.8807 15 19 16.1193 19 17.5ZM15 7C15 9.20914 13.2091 11 11 11C8.79086 11 7 9.20914 7 7C7 4.79086 8.79086 3 11 3C13.2091 3 15 4.79086 15 7Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button><button class="chat-header-btn" title="Open Settings" id="settings-btn"><svg width="20" height="20" viewBox="0 0 20 20" style="color:var(--text-color)"><path fill="currentColor" d="M10 8a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"></path><path fill="currentColor" fill-rule="evenodd" d="M9 2h2a2.01 2.01 0 0 0 1.235 1.855l.53.22a2.01 2.01 0 0 0 2.185-.439l1.414 1.414a2.01 2.01 0 0 0-.439 2.185l.22.53A2.01 2.01 0 0 0 18 9v2a2.01 2.01 0 0 0-1.855 1.235l-.22.53a2.01 2.01 0 0 0 .44 2.185l-1.415 1.414a2.01 2.01 0 0 0-2.184-.439l-.531.22A2.01 2.01 0 0 0 11 18H9a2.01 2.01 0 0 0-1.235-1.854l-.53-.22a2.009 2.009 0 0 0-2.185.438L3.636 14.95a2.009 2.009 0 0 0 .438-2.184l-.22-.531A2.01 2.01 0 0 0 2 11V9c.809 0 1.545-.487 1.854-1.235l.22-.53a2.009 2.009 0 0 0-.438-2.185L5.05 3.636a2.01 2.01 0 0 0 2.185.438l.53-.22A2.01 2.01 0 0 0 9 2zm-4 8 1.464 3.536L10 15l3.535-1.464L15 10l-1.465-3.536L10 5 6.464 6.464 5 10z" clip-rule="evenodd"></path></svg></button></div></div><div class="chat-messages" id="chat-messages"></div></div></div><script>var e=new URLSearchParams(window.location.search).get("id");e||window.location.replace("https://archive.org/details/@sputchik?sort=-date");let[D,,w]=e.split("-");e=`https://archive.org/download/${e}/`;let L=e+w+".json",N=e+w+"-metadata.json";var t=e+w+".mp4";let O=`https://corsproxy.io/?url=${e}${w}.tar.gz`,h=document.getElementById("video-player"),H=document.getElementById("chat-panel"),b=document.getElementById("chat-messages"),V=document.getElementById("viewer-count"),U=(h.src=t,e=window.matchMedia("(prefers-color-scheme: dark)").matches,t=localStorage.getItem("theme"),ze(e||!t?e?"dark":"light":t),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{ze(e.matches?"dark":"light")}),null),r={t:null,viewers:null,o:null},d=null,j=0,G=null,g=[],f=0,l=!1,s=0,J=null,X=new Set,m=new Map,_=new Map,p=null,q,v=100,x=250,y=4,k=`image${y}x`,$=!0,M=!0,B=!0,S=!0,I=!0,F=3,C=4,u=new Map,P=new Map,K=new Set,Q=new Set;new Set(["msg","monet","inraid","mod","misc"]);let Y=new Map,W=["#FF0000","#0000FF","#008000","#B22222","#FF7F50","#9ACD32","#FF4500","#2E8B57","#DAA520","#D2691E","#5F9EA0","#1E90FF","#FF69B4","#8A2BE2","#00FF7F"],A={i:'<path fill="currentColor" fill-rule="evenodd" d="M16 6h2v6h-1v6H3v-6H2V6h2V4.793c0-2.507 3.03-3.762 4.803-1.99.131.131.249.275.352.429L10 4.5l.845-1.268a2.81 2.81 0 0 1 .352-.429C12.969 1.031 16 2.286 16 4.793V6zM6 4.793V6h2.596L7.49 4.341A.814.814 0 0 0 6 4.793zm8 0V6h-2.596l1.106-1.659a.814.814 0 0 1 1.49.451zM16 8v2h-5V8h5zm-1 8v-4h-4v4h4zM9 8v2H4V8h5zm0 4H5v4h4v-4z" clip-rule="evenodd"></path>',reply:'<path fill="currentColor" d="M11 8h2v2h-2V8zM9 8H7v2h2V8z"></path><path fill="currentColor" fill-rule="evenodd" d="m10 18-3-3H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2l-3 3zm-2.172-5L10 15.172 12.172 13H15V5H5v8h2.828z" clip-rule="evenodd"></path>',sub:'<path fill="currentColor" d="M8.944 2.654c.406-.872 1.706-.872 2.112 0l1.754 3.77 4.2.583c.932.13 1.318 1.209.664 1.853l-3.128 3.083.755 4.272c.163.92-.876 1.603-1.722 1.132L10 15.354l-3.579 1.993c-.846.47-1.885-.212-1.722-1.132l.755-4.272L2.326 8.86c-.654-.644-.268-1.723.664-1.853l4.2-.583 1.754-3.77z"></path>',l:'<path fill="currentColor" d="M18 5v8a2 2 0 0 1-2 2H4a2.002 2.002 0 0 1-2-2V5l4 3 4-4 4 4 4-3z" fill-rule="evenodd"></path>',u:'<path fill="currentColor" fill-rule="evenodd" d="m11 14 7 4V2l-7 4H4a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h2v4h2v-4h3zm1-6.268 4-2.286v9.108l-4-2.286V7.732zM10 12H4V8h6v4z" clip-rule="evenodd"></path>'},Z=new Image,ee=(Z.src="https://static-cdn.jtvnw.net/subs-image-assets/gift-illus.png","VODArchiverCache"),i="chatLogs",te="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=null,a=document.createElement("button");function oe(e,t=20,o=20){var a=document.createElementNS("http://www.w3.org/2000/svg","svg");return a.setAttribute("width",t),a.setAttribute("height",o),a.setAttribute("viewBox",`0 0 ${t} `+o),a.style.color="var(--text-color)",a.style=`min-height: ${o}px; min-width: ${t}px;`,a.innerHTML=e,a}a.textContent="▼ Scroll to Bottom",a.style.cssText="position: absolute; bottom: 4%; left: 50%; transform: translateX(-50%); display: none; z-index: 3; width: 50%; height: fit-content; min-height: 33px; border-radius: 8px; border-color: var(--panel-border); background-color: var(--bg-color); color: var(--text-color);",a.addEventListener("click",()=>{b.scrollTop=b.scrollHeight}),H.appendChild(a),b.addEventListener("scroll",Ve);class n{constructor(e,t){this.operationName=e,this.sha256Hash=t,this.extensions={persistedQuery:{version:1,sha256Hash:this.sha256Hash}}}m(e={}){return{operationName:this.operationName,extensions:this.extensions,variables:e}}}class ae extends n{constructor(){super("BitsConfigContext_Global","6a265b86f3be1c8d11bdcf32c183e106028c6171e985cc2584d15f7840f5fee6")}}class ne extends n{constructor(){super("ChannelRoot_AboutPanel","0df42c4d26990ec1216d0b815c92cc4a4a806e25b352b66ac1dd91d5a1d59b80")}}class re extends n{constructor(){super("ChatList_Badges","838a7e0b47c09cac05f93ff081a9ff4f876b68f7624f0fc465fe30031e372fc2")}}class ie extends n{constructor(){super("GlobalBadges","9db27e18d61ee393ccfdec8c7d90f14f9a11266298c2e5eb808550b77d7bcdf6")}}let c=new class{p=new ae;h=new ne;g=new re;v=new ie};class T extends Error{constructor(e){super("string"==typeof e?e:JSON.stringify(e)),this.name="RequestError",this.k=e}}let E=new class{constructor(e=30,t=35,o=3e3){this.$=e,this.M=t,this.B=o,this.S=[],this.total=0,this.I=0,this.F=null,this.endpoint="https://gql.twitch.tv/gql",this.headers={"Client-ID":"kimne78kx3ncx6brgo4mv6wki5h1ko","Device-Id":Array(32).fill(0).map(()=>te.charAt(Math.floor(Math.random()*te.length))).join(""),"Accept-Language":"en-US"}}async add(t,n=10){for(;0<=n;){let o,a;var e=new Promise((e,t)=>{o=e,a=t}),r=(this.S.push({C:t,resolve:o,reject:a}),this.S.length),i=Date.now();1===r?(this.I=i,this.F=setTimeout(()=>{this.P(),this.$})):(r>=this.M||i-this.I>=this.$)&&(this.F&&(clearTimeout(this.F),this.F=null),this.P());try{return await e}catch(e){if(--n<0)throw r=t.operationName||"unknown",new Error(`Failed to execute operation "${r}" after retries: `+e.message)}}}async P(){if(this.S.length){var o=this.S,t=(this.S=[],this.F&&(clearTimeout(this.F),this.F=null),o.length);this.total+=t;try{console.debug(`Collecting ${t} promises...`);var a=JSON.stringify(o.map(e=>e.C)),n=this.A(a.length),r=Date.now();let e=new AbortController;var i=setTimeout(()=>e.abort(),this.B),l=await fetch(this.endpoint,{method:"POST",headers:{"Content-Type":"application/json",...this.headers},body:a,signal:e.signal});if(clearTimeout(i),!l.ok)throw new Error(`Invalid response status (${l.status})`);var s=await l.text(),c=this.A(s.length),d=JSON.parse(s),u=((Date.now()-r)/1e3).toFixed(2);console.debug(`Collected ${t} promise(s) (${n}) in ${u}s (${c}). Total: `+this.total);for(let e=0;e<o.length;e++){var m,p,h=o[e],g=d[e];g.errors?(m=new T(g.errors),p=h.C.operationName||"Unknown",console.warn(`[${p}] Operation error: `+JSON.stringify(g.errors)),h.reject(m)):h.resolve(g.data||g)}}catch(t){console.error(`Error collecting ${o.length} promises: `+t.message);for(let e=0;e<o.length;e++)o[e].reject(new T(t))}}}A(e){return e<1024?e+" B":e<1048576?(e/1024).toFixed(1)+" KB":(e/1048576).toFixed(1)+" MB"}};new class{constructor(){}T(e){}R(e){}D(e){}L(e){}N(e){}O(e){}H(e){}V(e){}U(e){}j(e){}G(e){}J(e){}X(e){}_(e){}q(e){}K(e){}Y(e){}};function le(){return new Promise((e,t)=>{let o=indexedDB.open(ee,1);o.onerror=()=>t(o.error),o.onsuccess=()=>e(o.result),o.onupgradeneeded=e=>{e=e.target.result;e.objectStoreNames.contains(i)||e.createObjectStore(i,{keyPath:"id"})}})}async function se(t){try{var o=t.stream(),a=new DecompressionStream("gzip"),n=o.pipeThrough(a),r=await new Response(n).arrayBuffer(),i=new Uint8Array(r),l={};let e=0;for(;e+512<=i.byteLength;){var s=i.slice(e,e+512),c=s.slice(0,100);let o="";for(let e=0;e<c.length&&0!==c[e];e++)o+=String.fromCharCode(c[e]);if(o.includes("@PaxHeader")){var d=s.slice(124,136);let t="";for(let e=0;e<d.length&&0!==d[e];e++)t+=String.fromCharCode(d[e]);var u=parseInt(t.trim(),8)||0;e+=512+512*Math.ceil(u/512)}else{var m=s.slice(124,136);let t="";for(let e=0;e<m.length&&0!==m[e];e++)t+=String.fromCharCode(m[e]);var p,h,g,f,v=parseInt(t.trim(),8)||0;console.log("Found file:",o,"size:",v),0<v&&(p=e+512,h=i.slice(p,p+v),g=new TextDecoder("utf-8").decode(h),f=JSON.parse(g),l[o]=f),e+=512+(0<v?512*Math.ceil(v/512):0)}}var b=w+"-metadata.json",x=w+".json";return l[b]&&l[x]?[l[b],l[x]]:(console.error("No target files found in tar:",l),null)}catch(e){return console.error("Failed to parse compressed chat log:",e),null}}async function ce(){if(!l){console.log("Looking for cached chat for stream:",w);var t=async()=>{console.log("Falling back to uncompressed chat log...");var[e,t]=await Promise.all([fetch(N),fetch(L)]);g=await t.json(),d=await e.json()},e=await(async n=>{try{let a=(await le()).transaction([i],"readonly").objectStore(i);return new Promise((e,t)=>{let o=a.get(n);o.onerror=()=>t(o.error),o.onsuccess=()=>{o.result&&o.result.W?e(o.result.W):e(null)}})}catch(e){return console.warn("IndexedDB not available, falling back to server fetch:",e),null}})(w);if(e instanceof Blob)[d,g]=await se(e),console.log("Chat loaded from IndexedDB cache");else{console.log("No cached chat found, trying compressed chat log first...");try{var o,a,n=await fetch(O);200===n.status&&(a=await se(o=await n.blob()))instanceof Array?([d,g]=a,await(async(n,r)=>{try{let a=(await le()).transaction([i],"readwrite").objectStore(i);return new Promise((e,t)=>{let o=a.put({id:n,W:r,timestamp:Date.now()});o.onerror=()=>t(o.error),o.onsuccess=()=>e()})}catch(e){console.warn("Could not cache chat in IndexedDB:",e)}})(w,o),console.log("Chat cached in IndexedDB for future use")):await t()}catch(e){console.warn("Failed to fetch compressed chat log:",e),await t()}if(!Array.isArray(g))return void console.error("Failed to load chat log from any source")}l=!0,f=g.length,G=d.owner,console.log("Chat loaded with",f,"messages")}}function de(e){return`https://static-cdn.jtvnw.net/emoticons/v2/${e}/default/dark/${F}.0`}function ue(t){if(t&&t.length){let e=t.length;for(;e--;)(e=>{var t;K.has(e)||(K.add(e),(t=new Image).src=de(e),t.onerror=()=>{console.warn("Failed to load emote:",e),K.delete(e)})})(t[e].id)}}function me(t){if(t&&t.length){let e=t.length;for(;e--;){var o=t[e];(e=>{var t,o;Q.has(e)||((t=P.get(e)||u.get(e))?((o=new Image).src=t[k],o.onerror=()=>{console.warn("Failed to load badge:",e)},o.onload=()=>{Q.add(e)}):console.warn("Unknown badge ID:",e))})(""+o.name+o.value)}}}function pe(){if(l){var t=g[s].offset;let e=s;for(;e<g.length&&g[e].offset<t+5;){var o=g[e];ue(o.data.emotes),me(o.data.badges),o.data.user&&!o.data.color&&(o=o.data.user.login,Y.has(o)||ye(o)),e++}}}function he(e,t,o,a,n){let r={PREFIX:e.toLowerCase(),BACKGROUND:t,ANIMATION:o?"animated":"static",TIER:a,SCALE:n,EXTENSION:o?"gif":"png"};return J.replace(/\b(PREFIX|BACKGROUND|ANIMATION|TIER|SCALE|EXTENSION)\b/g,e=>r[e])}function ge(n=null){if(null===J)console.warn("Bits template URL not set");else{let o=0,a=0;for(var[e,t]of m.entries())o+=t.length-1;n&&n(a,o);for(var[r,i]of m.entries()){let t=i.length;for(;t--;){var l=i[t];let e=he(r,"dark",!0,l,C);l=new Image;l.onload=()=>{a++,n&&n(a,o)},l.onerror=()=>{console.warn("Failed to preload bits image:",e),a++,n&&n(a,o)},l.src=e}}}}function fe(e=null){var t,o=Array.from(u.values()),a=Array.from(P.values());let n=o.length+a.length,r=0,i=(e&&e(r,n),()=>{r++,e&&e(r,n)});for(t of[o,a])for(var l of t){let e=""+l.setID+l.version;var s=new Image;s.onload=i,s.onerror=()=>{console.warn("Failed to preload badge:",e),i()},s.src=l[k]}}function ve(){var t=new Set;let e=g.length;for(;e--;){var o=g[e];if(o.data.emotes)for(let e=0;e<o.data.emotes.length;e++)t.add(o.data.emotes[e].id)}return t}function be(t=null){var o=ve();let a=o.size,n=0;t&&t(n,a);for(let e of o){var r=new Image;r.onload=()=>{n++,t&&t(n,a)},r.onerror=()=>{console.warn("Failed to preload emote:",e),n++,t&&t(n,a)},r.src=de(e)}}function xe(t=null){let e,o,a=0,n=0,r=0,i=0;var l,s;e=ve().size,o=u.size+P.size;for([l,s]of m.entries())a+=s.length-1;let c=e+o+a,d=()=>{var e=n+r+i;t&&t(e,c)};be((e,t)=>{n=e,d()}),fe((e,t)=>{r=e,d()}),ge((e,t)=>{i=e,d()})}function z(e,t,o){e.querySelector(t).addEventListener("click",function(){let i=this;var e;i.dataset.Z=i.style.color||"",i.style.color="#FFFFFF",(e=i).disabled=!0,e.dataset.ee=e.textContent,e.dataset.te=e.style.backgroundColor||"",o((e,t)=>{var o,a,n,r;o=i,r=e,n=0<(a=t)?Math.round(r/a*100):0,o.textContent=r+`/${a} (${n}%)`,o.style.background=`linear-gradient(to right, var(--accent-color, #9147ff) ${n}%, var(--panel-border) ${n}%)`,t<=e&&((r=i).disabled=!1,r.style.backgroundImage="",r.textContent=r.dataset.ee,r.style.backgroundColor=r.dataset.te||"var(--panel-border)",r.style.color=r.dataset.Z||"var(--text-color)",delete r.dataset.ee)})})}function we(o,e,t=!1){if(!e.length&&!t)return document.createTextNode(o);var a,n=[];if(e&&n.push(...e.flatMap(t=>t.pos.map(e=>({oe:!1,start:e,end:e+t.len-1,id:t.id})))),t&&p)for(p.lastIndex=0;null!==(a=p.exec(o));)n.push({oe:!0,start:a.index,end:a.index+a[0].length-1,ae:a[1],ne:parseInt(a[2],10)});n.sort((e,t)=>e.start-t.start);var r=document.createDocumentFragment();let i=0;for(let e=0,t=n.length;e<t;e++){var l=n[e],s=(l.start>i&&(s=o.substring(i,l.start),r.appendChild(document.createTextNode(s))),document.createElement("img"));if(s.onerror=function(){this.replaceWith(document.createTextNode(this.alt))},l.oe){var c=m.get(l.ae.toLowerCase());let t=1;if(c)for(let e=c.length-1;0<=e;e--)if(l.ne>=c[e]){t=c[e];break}var d=document.createElement("span"),u=(d.className="bits-container",d.style="display: inline-flex; align-items: center; vertical-align: middle; gap: 2px; margin-left: 2px; margin-right: 2px;",s.src=he(l.ae,"dark",!0,t,C),s.title=s.alt=""+l.ae+t,s.style="height: 1.6rem; width: auto; vertical-align: middle;",document.createElement("span"));u.textContent=l.ne.toString(),u.style=`font-weight: bold; color: ${_.get(t)};`,d.appendChild(s),d.appendChild(u),r.appendChild(d)}else s.src=de(l.id),s.title=s.alt=o.substring(l.start,l.end+1),s.style.cssText="height: 1.6rem; width: auto; vertical-align: middle; margin-left: 0.5px;",r.appendChild(s);i=l.end+1}return i<o.length&&(e=o.substring(i),r.appendChild(document.createTextNode(e))),r}function ye(e){var t=e.toString().split("").reduce((e,t)=>(e<<5)-e+t.charCodeAt(0)|0,0),t=Math.abs(t)%W.length,t=W[t];return Y.set(e,t),t}function ke(e){return Y.get(e)||ye(e)}function R(e,t=!0){var o=document.createElement("span"),a=(o.className="chat-username",e.color||ke(e.user.login));if(o.style=`color: ${a}; cursor: pointer;`,o.textContent=e.user["display-name"]||e.user.login,o.onclick=()=>De(e.user),!(t&&S&&e.badges&&e.badges.length))return o;var n,a=document.createElement("span"),r=document.createElement("span");r.style="margin-right: 4px;";for(n of e.badges){var i,l=""+n.name+n.value,s=P.get(l)||u.get(l);s?((i=document.createElement("img")).src=s[k],i.style="height: 1.0rem; width: auto; vertical-align: middle; margin-right: 4px;",i.title=i.alt=s.title,r.appendChild(i)):console.warn("Badge not found: "+l)}return a.appendChild(r),a.appendChild(o),a}function $e(e){var t,o,a,n,r,i,l=e.type,s=e.data,c=document.createElement("div");c.className="chat-message "+l,c.id=s.id||0,$&&((t=document.createElement("span")).className="timestamp",t.textContent=(e=e.offset-j,a=(i=e<(o=0))?-e:e,n=Math.floor(a/3600),r=Math.floor(a%3600/60),a=Math.floor(a%60),i=i?"-":"",n=0<n?i+n.toString().padStart(2,"0")+`:${r.toString().padStart(2,"0")}:`+a.toString().padStart(2,"0"):i+r.toString().padStart(2,"0")+":"+a.toString().padStart(2,"0"),o?n+"."+(e%1).toFixed(o).substring(2):n),c.appendChild(t));let d,u;switch(l){case"msg":u=R(s);var m=document.createElement("span"),p=(m.className="chat-text",m.textContent=": ",we(s.text,s.emotes));if("reply"===(d=s["msg-id"])){var h=oe(A.reply,18,18),g=(h.style.color="var(--timestamp-color)",document.createElement("div")),h=(g.style="display: flex; gap: 5px; margin-bottom: 2px; align-items: center;",g.appendChild(h),s.reply["parent-msg-body"]),h=`Replying to @${s.reply["parent-display-name"]}: `+h,f=s["parent-msg-id"];let t=b.querySelector(`.chat-message[id="${f}"]`);var v=document.createElement(t?"a":"span");t&&(v.href="#"+f,v.onclick=e=>{e.preventDefault(),t.scrollIntoView(),t.style.backgroundColor="rgba(255,255,0,0.3)",setTimeout(()=>t.style.backgroundColor="",200)}),v.textContent=h,v.style="color: var(--timestamp-color);",g.appendChild(v),c.appendChild(g)}m.appendChild(p),c.appendChild(u),c.appendChild(m);break;case"monet":if("bits"===(d=s["msg-id"])){c.className="chat-message msg";f=document.createElement("span"),h=(f.className="chat-text",f.textContent=": ",we(s.text,s.emotes,!0));f.appendChild(h),c.appendChild(R(s)),c.appendChild(f)}else{if(!B)return;(u=R(s,addBadges=!1)).style.color="var(--sub-color)";var v=s.user["display-name"]||s.user.login,g=document.createElement("span");g.className="chat-text",g.style.fontSize="0.9rem";let o=s["system-msg"];if(o.startsWith(v)&&(o=o.substring(v.length).trimStart()),"resub"===d||"sub"===d)return o.startsWith("subscribed")&&(o=o.charAt(0).toUpperCase()+o.slice(1)),g.textContent=" "+o,(p=document.createElement("div")).style="display: flex; flex-direction: column; gap: 2px;",m=document.createElement("div"),(f=oe((h="Prime"===s["msg-params"]["sub-plan"])?A.l:A.sub,20,20)).style.color=h?"var(--sub-color)":"var(--game-name-color)",m.style="display: flex; align-items: center; gap: 4px;",g.style.marginLeft="24px",m.appendChild(f),m.appendChild(u),p.appendChild(m),p.appendChild(g),c.appendChild(p),s.text&&((v=document.createElement("div")).style.marginTop="8px",(h=document.createElement("span")).className="chat-text",h.textContent=": ",f=we(s.text,s.emotes),h.appendChild(f),v.appendChild(R(s)),v.appendChild(h),c.appendChild(v)),c;if("submysterygift"===d||"subgift"===d){g.textContent=" "+o;var m=document.createElement("div"),p=(m.style="display: flex; align-items: center; gap: 3px;",u.style.fontWeight="bold",document.createElement("div")),f=document.createElement("span");f.className="chat-text";let e=s["system-msg"];h=s.user["display-name"]||s.user.login;e.startsWith(h)&&(e=e.substring(h.length).trimStart()),f.textContent=" "+e,f.style.fontSize="0.9rem";let t;return"submysterygift"===d?((t=document.createElement("img")).src=Z.src,t.style="height: 45px; width: auto;",u.style.color=s.color||ke(s.user.login),p.style="display: flex; flex-direction: column;"):(t=oe(A.i),u.style.color="var(--text-color)",p.style.marginLeft="4px"),p.appendChild(u),p.appendChild(f),m.appendChild(t),m.appendChild(p),c.appendChild(m),c}g.textContent=" "+o,c.appendChild(u),c.appendChild(g),s.text&&((v=document.createElement("div")).style.marginTop="4px",h=R(s),(f=document.createElement("span")).className="chat-text",f.textContent=": ",p=we(s.text,s.emotes),f.appendChild(p),v.appendChild(h),v.appendChild(f),c.appendChild(v))}break;case"inraid":(u=R(s)).style.color="#ff8b38";m=document.createElement("span");m.className="chat-text",m.textContent=` is raiding with a party of ${s["msg-params"].viewerCount} viewers`,c.appendChild(u),c.appendChild(m);break;case"mod":if(!M)return;g=document.createElement("span");if(g.className="chat-text","ban"===s["msg-id"])s.user=s["target-user"],(u=R(s,!1)).style.color="var(--text-color)",c.appendChild(u),g.style.color="var(--text-color)",g.textContent=" was banned",s["ban-duration"]&&(g.textContent+=` for ${s["ban-duration"]} seconds`);else if("clear-msg"===s["msg-id"]){let t=b.querySelector(`.chat-message[id="${s["target-msg-id"]}"]`);if(!t)return;p=t.querySelector(".chat-text"),h=(p&&(p.style.opacity="0.7"),document.createElement("a"));h.href="#"+t.id,h.textContent="message deleted",h.style="cursor: pointer; margin-left: 5px; color: #999;",h.addEventListener("click",e=>{e.preventDefault(),t.scrollIntoView(),t.style.backgroundColor="rgba(255,255,0,0.3)",setTimeout(()=>t.style.backgroundColor="",200)}),g.appendChild(h)}else g.textContent="Moderation action";c.appendChild(g);break;case"poll":case"prediction":f=document.createElement("div");f.style.fontWeight="bold",f.textContent=l.charAt(0).toUpperCase()+l.slice(1)+": ","poll"===l&&s.data&&s.data.poll?f.textContent+=s.data.poll.title||"":"prediction"===l&&s.data&&s.data.event&&(f.textContent+=s.data.event.title||""),c.appendChild(f);break;default:v=document.createElement("span");v.className="chat-text",v.textContent=`[${l}] Event`,c.appendChild(v)}return c}function Me(){if(l&&f){var e=h.currentTime;let t=s;for(;t<g.length&&g[t].offset<=e;)t++;if(t>s){var o=document.createDocumentFragment();for(let e=s;e<t;e++){var a=$e(g[e]);a&&o.appendChild(a)}var n,r=b.scrollHeight-b.clientHeight<=b.scrollTop+100,i=(b.appendChild(o),s=t,b.children);i.length>x&&((n=document.createRange()).setStart(b,0),n.setEnd(b,i.length-x),n.deleteContents()),(r?He:Ve)()}}}function Be(){s=s>=x?s-x:0,b.innerHTML="",Me()}function Se(){let t=document.querySelector(".container"),o=document.getElementById("resize-handle"),a,n,r;function i(e){e=e.clientX-a,e=Math.max(200,Math.min(r-200,n-e));H.style.width=e+"px"}function l(){document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",l),o.classList.remove("active"),document.body.style.userSelect=""}o.addEventListener("mousedown",function(e){a=e.clientX,n=H.offsetWidth,r=t.offsetWidth,document.addEventListener("mousemove",i),document.addEventListener("mouseup",l),o.classList.add("active"),document.body.style.userSelect="none"})}function Ie(){var e,t;h.paused||(t=(t=>{let o=1/0;var a=d.titles,n=d.games;if(a&&a.length)for(let e=0;e<a.length;e++){var[r,,]=a[e];t<r&&r<o&&(o=r)}if(n&&n.length)for(let e=0;e<n.length;e++){var[i,,]=n[e];t<i&&i<o&&(o=i)}return o===1/0?null:o})(e=h.currentTime),r.t&&(clearTimeout(r.t),r.t=null),t&&(t=1e3*(t-e)/h.playbackRate+50,r.t=setTimeout(()=>{Ee(),Ie()},t)))}function Fe(){if(!h.paused){var o,a,n=h.currentTime;a=n;let[e,t]=(o=d.viewers)&&o.length?0<=(a=Ae(a))&&a<o.length-1?[a+1,o[a+1][0]]:[0,o[0][0]]:null;r.viewers&&(clearTimeout(r.viewers),r.viewers=null),t&&(a=1e3*(t-n)/h.playbackRate,r.viewers=setTimeout(()=>{Te(index=e),Fe()},a))}}function Ce(){h.paused||(r.o&&(clearTimeout(r.o),r.o=null),r.o=setTimeout(()=>{pe(),Ce()},4e3))}function Pe(){for(var e in r)r[e]&&(clearTimeout(r[e]),r[e]=null)}function Ae(o){var a=d.viewers;if(!a.length||o<a[0][0])return-1;var n,r,e=Math.floor(o/30),i=Math.max(0,e-3),l=Math.min(a.length-1,e+3);let s=-1,c=-1;for(let e=i;e<=l;e++){var[t,,]=a[e];t<=o&&t>c&&(c=t,s=e)}if(-1===s)for(let e=0,t=a.length;e<t;e++)e>=i&&e<=l||([n,r]=a[e],n<=o&&n>c&&(c=n,s=e));return s}function Te(e=null){e=e||Ae(h.currentTime),e=0<=e?d.viewers[e][1]:0;V.textContent=e.toLocaleString()}function Ee(){var o=Math.ceil(h.currentTime),a=d.titles,n=d.games;if(a&&a.length){let t=a[0][1];for(let e=a.length-1;0<=e;e--){var[r,i]=a[e];if(r<=o){t=i;break}}document.querySelector(".stream-title").textContent=t,document.title=t+" - "+G.displayName}if(n&&n.length){let t=n[0][1]||"";for(let e=n.length-1;0<=e;e--){var[l,s]=n[e];if(l<=o){t="object"==typeof s?s.name:s;break}}document.getElementById("game-name").textContent=t}}function ze(e){document.documentElement.setAttribute("data-theme",e),localStorage.setItem("theme",e),document.getElementById("moon-icon").style.display="light"===e?"none":"block",document.getElementById("sun-icon").style.display="light"===e?"block":"none"}function Re(){ze("light"===(localStorage.getItem("theme")||"light")?"dark":"light")}function De(e){let s=e.id;var e=e["display-name"]||e.login,c=document.getElementById("user-chat-window-"+s);if(!c){let t=document.createElement("div");t.id="user-chat-window-"+s,t.className="popout";c=document.createElement("div"),e=(c.style.cssText=` padding: 5px; cursor: move; background-color: var(--panel-border); color: var(--text-color); border-bottom: 1px solid var(--panel-border); display: flex; justify-content: space-between; align-items: center; z-index: 11; `,c.textContent="Chat History for "+e,document.createElement("button"));e.textContent="X",e.style.cssText=` background: none; border: none; color: var(--text-color); cursor: pointer; padding: 0 5px; `,e.onclick=()=>{t.remove()},e.ontouchend=()=>t.remove(),c.appendChild(e),t.appendChild(c);let o=document.createElement("div"),a=(o.style.cssText=` flex-grow: 1; overflow-y: auto; padding: 5px; background-color: var(--panel-bg); `,t.appendChild(o),document.createElement("button")),n=(a.textContent="Load All Messages",a.style.cssText=` width: 100%; padding: 8px; background-color: var(--panel-border); color: var(--text-color); border: none; cursor: pointer; `,t.appendChild(a),document.body.appendChild(t),!1),r,i,l=(c.onmousedown=e=>{n=!0,r=e.clientX-t.offsetLeft,i=e.clientY-t.offsetTop,e.preventDefault(),document.onmousemove=e=>{n&&(t.style.left=e.clientX-r+"px",t.style.top=e.clientY-i+"px")},document.onmouseup=()=>{n=!1,document.onmousemove=null,document.onmouseup=null}},c.addEventListener("touchstart",e=>{e.preventDefault(),n=!0;e=e.touches[0];r=e.clientX-t.offsetLeft,i=e.clientY-t.offsetTop},{passive:!1}),document.addEventListener("touchmove",e=>{n&&(e.preventDefault(),e=e.touches[0],t.style.left=e.clientX-r+"px",t.style.top=e.clientY-i+"px")},{passive:!1}),document.addEventListener("touchend",()=>{n=!1},{passive:!1}),0);a.onclick=function(){for(var e=document.createDocumentFragment();l<f;){var t=p();t&&e.appendChild(t),l++}a.remove(),o.appendChild(e)};for(var d=h.currentTime+j,u=document.createDocumentFragment();l<f&&g[l].offset<=d;){var m=p();m&&u.appendChild(m),l++}function p(){var e=g[l],t=e.data.user||e.data["target-user"];if(t&&t.id===s)return $e(e)}o.appendChild(u),o.scrollTop=o.scrollHeight}}function Le(){var t=prompt("Enter username for chatlog history:");if(t){var o=t.toLowerCase();for(let e=0;e<f;e++){var a=g[e];if(a.data.user&&(a.data.user.login===o||a.data.user["display-name"]===t))return void De(a.data.user)}}}function Ne(){var e=document.getElementById("message-borders-style")||document.createElement("style");e.id="message-borders-style",I?e.textContent="":e.textContent=".chat-message { border-bottom: none !important; }",e.parentNode||document.head.appendChild(e)}function Oe(){let t=document.createElement("div"),a=(t.className="modal",document.createElement("div")),n=(a.className="settings-panel",a.innerHTML=` <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"><h2 style="margin: 0; color: var(--text-color);">Settings</h2><button id="settings-close" style="background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text-color);">&times;</button></div><div style="margin-bottom: 15px;"><label style="display: block; margin-bottom: 5px; font-weight: bold;">Emoji Resolution (1-3): <span id="emote-res-value">${F}</span></label><input type="range" id="emote-res" min="1" max="3" value="${F}" style="width: 100%;"><button id="preload-emotes" style="margin-top: 5px; padding: 5px 10px; background-color: var(--panel-border); border: none; border-radius: 4px; color: var(--text-color); cursor: pointer;">Preload Emotes</button></div><div style="margin-bottom: 15px;"><label style="display: block; margin-bottom: 5px; font-weight: bold;">Bits Resolution (1-4): <span id="bits-res-value">${C}</span></label><input type="range" id="bits-res" min="1" max="4" value="${C}" style="width: 100%;"><button id="preload-bits" style="margin-top: 5px; padding: 5px 10px; background-color: var(--panel-border); border: none; border-radius: 4px; color: var(--text-color); cursor: pointer;">Preload Bits</button></div><div style="margin-bottom: 15px;"><label style="display: block; margin-bottom: 5px; font-weight: bold;">Badges Resolution: <span id="badges-res-value">${y}</span></label><select id="badges-res" style="width: 100%; padding: 5px; background-color: var(--bg-color); border: 1px solid var(--panel-border); color: var(--text-color); border-radius: 4px;"><option value="1" ${1===y?"selected":""}>1x</option><option value="2" ${2===y?"selected":""}>2x</option><option value="4" ${4===y?"selected":""}>4x</option></select><button id="preload-badges" style="margin-top: 5px; padding: 5px 10px; background-color: var(--panel-border); border: none; border-radius: 4px; color: var(--text-color); cursor: pointer;">Preload Badges</button></div><div style="margin-bottom: 15px;"><button id="preload-all" style="width: 100%; padding: 10px; background-color: var(--accent-color); border: none; border-radius: 4px; color: white; cursor: pointer; font-weight: bold;">Preload All Assets</button></div><div style="margin-bottom: 15px;"><label style="display: block; margin-bottom: 5px; font-weight: bold;">Chat History Buffer (50-1000): <span id="history-value">${x}</span></label><input type="range" id="chat-history" min="50" max="1000" step="10" value="${x}" style="width: 100%;"></div><div style="margin-bottom: 15px;"><label style="display: block; margin-bottom: 5px; font-weight: bold;">Chat Update Speed (10-1000ms): <span id="update-speed-value">${v}</span>ms</label><input type="range" id="chat-update-speed" min="10" max="1000" step="10" value="${v}" style="width: 100%;"></div><div style="margin-bottom: 15px;"><label style="display: flex; align-items: center; margin-bottom: 10px;"><input type="checkbox" id="show-timestamps" ${$?"checked":""} style="margin-right: 8px;"> Show message timestamps </label><label style="display: flex; align-items: center; margin-bottom: 10px;"><input type="checkbox" id="show-badges" ${S?"checked":""} style="margin-right: 8px;"> Show user badges </label><label style="display: flex; align-items: center; margin-bottom: 10px;"><input type="checkbox" id="show-sub-messages" ${B?"checked":""} style="margin-right: 8px;"> Show gifted subscriptions, subscription messages </label><label style="display: flex; align-items: center; margin-bottom: 10px;"><input type="checkbox" id="show-ban-messages" ${M?"checked":""} style="margin-right: 8px;"> Show moderation messages </label><label style="display: flex; align-items: center; margin-bottom: 10px;"><input type="checkbox" id="show-message-borders" ${I?"checked":""} style="margin-right: 8px;"> Show message borders </label></div><div style="display: flex; gap: 10px; margin-top: 20px;"><button id="settings-save" style="flex: 1; padding: 10px; background-color: var(--accent-color); border: none; border-radius: 4px; color: white; cursor: pointer; font-weight: bold;">Save & Close</button><button id="settings-cancel" style="flex: 1; padding: 10px; background-color: var(--panel-border); border: none; border-radius: 4px; color: var(--text-color); cursor: pointer;">Cancel</button></div> `,t.appendChild(a),document.body.appendChild(t),a.querySelector("#emote-res")),e=a.querySelector("#emote-res-value"),r=(n.addEventListener("input",()=>{e.textContent=n.value}),a.querySelector("#bits-res")),o=a.querySelector("#bits-res-value"),i=(r.addEventListener("input",()=>{o.textContent=r.value}),a.querySelector("#badges-res")),l=a.querySelector("#badges-res-value"),s=(i.addEventListener("change",()=>{l.textContent=i.value}),a.querySelector("#chat-history")),c=a.querySelector("#history-value"),d=(s.addEventListener("input",()=>{c.textContent=s.value}),a.querySelector("#chat-update-speed")),u=a.querySelector("#update-speed-value"),m=(d.addEventListener("input",()=>{u.textContent=d.value}),z(a,"#preload-emotes",be),z(a,"#preload-bits",ge),z(a,"#preload-badges",fe),z(a,"#preload-all",xe),()=>t.remove());a.querySelector("#settings-close").addEventListener("click",m),a.querySelector("#settings-cancel").addEventListener("click",m),t.addEventListener("click",e=>{e.target===t&&m()}),a.querySelector("#settings-save").addEventListener("click",()=>{F=parseInt(n.value),C=parseInt(r.value);var e=parseInt(i.value),t=(x=parseInt(s.value),parseInt(d.value)),o=($=a.querySelector("#show-timestamps").checked,S=a.querySelector("#show-badges").checked,B=a.querySelector("#show-sub-messages").checked,M=a.querySelector("#show-ban-messages").checked,a.querySelector("#show-message-borders").checked);y!==e&&(y=e,k=`image${y}x`),t!==v&&(v=t,clearInterval(U),U=setInterval(()=>{h.paused||Me()},v)),o!==I&&(I=o,Ne()),e={emoteRes:F,bitsRes:C,badgesRes:y,chatHistoryLength:x,chatUpdateInterval:v,showMessageTimestamp:$,showUserBadges:S,showSubMessages:B,showBanMessages:M,showMessageBorders:I},localStorage.setItem("settings",JSON.stringify(e)),m(),Be()})}function He(){o&&o.disconnect(),(o=new MutationObserver(()=>{b.scrollTop=b.scrollHeight,o.disconnect(),o=null})).observe(b,{childList:!0,subtree:!0}),b.scrollTop=b.scrollHeight,setTimeout(()=>{o&&(o.disconnect(),o=null),b.scrollTop=b.scrollHeight},v)}function Ve(){var e=b.scrollHeight-b.clientHeight<=b.scrollTop+100;a.style.display=e?"none":"block"}document.addEventListener("DOMContentLoaded",async()=>{Se();var e=localStorage.getItem("settings");if(e)try{"emoteRes"in(e=JSON.parse(e))&&(F=e.emoteRes),"bitsRes"in e&&(C=e.bitsRes),"badgesRes"in e&&(y=e.badgesRes),"chatHistoryLength"in e&&(x=e.chatHistoryLength),"chatUpdateInterval"in e&&(v=e.chatUpdateInterval),"showMessageTimestamp"in e&&($=e.showMessageTimestamp),"showUserBadges"in e&&(S=e.showUserBadges),"showSubMessages"in e&&(B=e.showSubMessages),"showBanMessages"in e&&(M=e.showBanMessages),"showMessageBorders"in e&&(I=e.showMessageBorders),k=`image${y}x`,I||Ne()}catch(e){console.error("Failed to load settings:",e)}await Promise.all([ce(),(async()=>{var e=await E.add(c.v.m());if(e.errors)throw new T(e.errors);var t=e.badges;let o=t.length;for(;o--;){var a=t[o];u.set(""+a.setID+a.version,a)}})(),(async()=>{var e=await E.add(c.g.m({channelLogin:D}));if(e.errors)throw new T(e.errors);var t=e.user.broadcastBadges;let o=t.length;for(;o--;){var a=t[o];P.set(""+a.setID+a.version,a)}})(),(async()=>{var e=await E.add(c.p.m());if(e.errors)throw new T(e.errors);var t=e.cheerConfig.groups[0],o=e.cheerConfig.displayConfig.colors;J=t.templateURL;for(let e=0;e<o.length;e++){var a=o[e];_.set(a.bits,a.color)}for(let e=0;e<t.nodes.length;e++){var n=t.nodes[e];if("DISPLAY_ONLY"!==n.type){X.add(n.prefix);var r=new Array;for(let e=0;e<n.tiers.length;e++)r.push(n.tiers[e].bits);var i=n.prefix.toLowerCase();m.set(i,r)}}e=Array.from(X).join("|"),p=new RegExp(`(?:^|\\s)(${e})(\\d+)(?=\\s|$)`,"gi")})(),(async()=>{var e=await E.add(c.h.m({channelLogin:D,skipSchedule:!0,includeIsDJ:!1}));if(e.errors)throw new T(e.errors);(q=e.user.primaryColorHex)&&((e=document.createElement("style")).id="channel-color-style",e.textContent=`.chat-message.monet { border-left-color: #${q} !important; }`,e.parentNode||document.head.appendChild(e))})()]),Te(),Ee(),pe(),h.addEventListener("play",()=>{Ie(),Fe(),Ce(),b.scrollHeight-b.clientHeight>=b.scrollTop+100&&He()}),h.addEventListener("pause",()=>{Pe()}),h.addEventListener("ratechange",()=>{h.paused||(Pe(),Ie(),Fe(),Ce())}),U=setInterval(()=>{h.paused||Me()},v),h.addEventListener("seeking",()=>{Pe(),Ee(),Te()}),h.addEventListener("seeked",()=>{Pe(),s=(t=>{var o=t/h.duration,o=Math.floor(f*o);if(t>h.duration)return f-1;if(g[o].offset<t){for(let e=o;e<f;e++)if(g[e].offset>t)return e-1}else for(let e=o;0<=e;e--)if(g[e].offset<t)return e;return 0})(h.currentTime),Te(),Ee(),pe(),Be()}),document.getElementById("settings-btn").addEventListener("click",Oe),document.getElementById("chatlog-btn").addEventListener("click",Le),document.getElementById("theme-toggle-btn").addEventListener("click",Re)});</script>